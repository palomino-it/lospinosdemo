<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Procesar Datos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/custom.css" rel="stylesheet">
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="img/RLP_LOGO.png" alt="RLP" class="logo-navbar">
        <img src="img/ML_LOGO.png" alt="ML" class="logo-navbar">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">üè† Principal</a></li>
          <li class="nav-item"><a class="nav-link" href="inventario.html">üì¶ Inventario</a></li>
          <li class="nav-item"><a class="nav-link" href="clientes.html">üë• Clientes</a></li>
          <li class="nav-item"><a class="nav-link" href="estado_cuenta.html">üíº Estado de Cuenta</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5 pt-5">
    <div class="card shadow-lg p-4 rounded-4">
      <h2 class="text-center mb-4">Resumen Final del Expediente</h2>

      <div id="alert-container"></div>

      <div class="accordion" id="accordionResumen">

        <!-- Titular -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTitular">
              üë§ Datos del Titular
            </button>
          </h2>
          <div id="collapseTitular" class="accordion-collapse collapse show" data-bs-parent="#accordionResumen">
            <div class="accordion-body" id="resumen-titular">
              <p class="text-muted">No hay datos registrados.</p>
            </div>
          </div>
        </div>

        <!-- Beneficiario -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseBeneficiario">
              ü§ù Datos del Beneficiario
            </button>
          </h2>
          <div id="collapseBeneficiario" class="accordion-collapse collapse" data-bs-parent="#accordionResumen">
            <div class="accordion-body" id="resumen-beneficiario">
              <p class="text-muted">No hay datos registrados.</p>
            </div>
          </div>
        </div>

        <!-- Inmueble -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseInmueble">
              üè† Datos del Inmueble
            </button>
          </h2>
          <div id="collapseInmueble" class="accordion-collapse collapse" data-bs-parent="#accordionResumen">
            <div class="accordion-body" id="resumen-inmueble">
              <p class="text-muted">No hay datos registrados.</p>
            </div>
          </div>
        </div>

        <!-- Compraventa -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseCompraventa">
              üí∞ Datos de Compraventa
            </button>
          </h2>
          <div id="collapseCompraventa" class="accordion-collapse collapse" data-bs-parent="#accordionResumen">
            <div class="accordion-body" id="resumen-compraventa">
              <p class="text-muted">No hay datos registrados.</p>
            </div>
          </div>
        </div>

      </div>

      <div class="d-grid gap-2 mt-4 d-print-none">
        <button class="btn btn-secondary btn-lg" onclick="window.print()">üñ®Ô∏è Imprimir Ficha</button>
        <button class="btn btn-success btn-lg" id="btn-finalizar">‚úÖ Confirmar y Guardar Expediente</button>
        <button class="btn btn-outline-danger" id="btn-limpiar">üóëÔ∏è Borrar y Reiniciar</button>
      </div>
    </div>
  </div>

  <style>
    /* Forzar ocultamiento en pantalla sin depender de cach√© de CSS externo */
    #print-area {
      display: none !important;
    }

    @media print {
      #print-area {
        display: block !important;
      }
    }
  </style>

  <!-- ================= Plantilla de Impresi√≥n ================= -->
  <div class="p-4" id="print-area">
    <div class="print-header mb-5">
      <div class="print-logos">
        <img src="img/RLP_LOGO.png" alt="RLP" class="print-logo">
        <div class="text-center flex-grow-1">
          <h3>RESIDENCIALES "LOS PINOS"</h3>
          <h4>Ficha de Control de Compraventa</h4>
        </div>
        <img src="img/ML_LOGO.png" alt="ML" class="print-logo">
      </div>
      <p class="text-end small">Fecha de Emisi√≥n: <span id="print-fecha"></span></p>
    </div>

    <div class="row mb-4">
      <div class="col-12 border p-3">
        <h4>1. DATOS DEL TITULAR</h4>
        <div id="print-titular" class="row"></div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12 border p-3">
        <h4>2. DATOS DEL BENEFICIARIO</h4>
        <div id="print-beneficiario" class="row"></div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12 border p-3">
        <h4>3. IDENTIFICACI√ìN DEL INMUEBLE</h4>
        <div id="print-inmueble" class="row"></div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12 border p-3">
        <h4>4. CONDICIONES DE LA COMPRAVENTA</h4>
        <div id="print-compraventa" class="row"></div>
        <div class="mt-3">
          <strong>Pagos Programados:</strong>
          <ul id="print-pagos" class="list-unstyled ps-3"></ul>
        </div>
      </div>
    </div>

    <div class="row mt-5 pt-5 text-center">
      <div class="col-5 border-top border-dark">
        <p>Firma del Cliente</p>
      </div>
      <div class="col-2"></div>
      <div class="col-5 border-top border-dark">
        <p>Firma del Vendedor / Administraci√≥n</p>
      </div>
    </div>
  </div>

  <style>
    @media print {
      body * {
        visibility: hidden;
      }

      #print-area,
      #print-area * {
        visibility: visible;
      }

      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }

      .accordion,
      .navbar,
      .btn {
        display: none !important;
      }

      .card {
        box-shadow: none !important;
        border: none !important;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    function renderObject(obj, containerId, editUrl) {
      if (!obj) return;
      let html = '<ul class="list-group">';
      for (const [key, value] of Object.entries(obj)) {
        if (key === 'pagos') {
          html += `<li class="list-group-item active">Pagos Fraccionados:</li>`;
          if (Array.isArray(value)) {
            value.forEach((p, i) => {
              html += `<li class="list-group-item ms-3">Pago ${i + 1}: ${p.fecha} - Q${p.cantidad}</li>`;
            });
          }
        } else if (['id_existente', 'es_existente', 'es_cliente_existente'].includes(key)) {
          // Ocultar claves internas
          continue;
        } else {
          html += `<li class="list-group-item"><strong>${key}:</strong> ${value}</li>`;
        }
      }
      html += '</ul>';

      if (editUrl) {
        html += `<div class="mt-3 text-end d-print-none">
                   <a href="${editUrl}" class="btn btn-sm btn-outline-primary">‚úèÔ∏è Editar</a>
                 </div>`;
      }

      const container = document.getElementById(containerId);
      if (container) container.innerHTML = html;
    }

    function renderPrintObject(obj, containerId) {
      if (!obj) return;
      let html = '';
      for (const [key, value] of Object.entries(obj)) {
        if (key === 'pagos') continue;
        // Formato clave-valor simple para impresi√≥n, reordenando si es necesario
        html += `<div class="col-6 mb-1"><strong>${key}:</strong> ${value}</div>`;
      }
      const container = document.getElementById(containerId);
      if (container) container.innerHTML = html;
    }

    const titular = cargarDatos('titular');
    const beneficiario = cargarDatos('beneficiario');
    const inmueble = cargarDatos('inmueble');
    const compraventa = cargarDatos('compraventa');

    // Render Web View
    renderObject(titular, 'resumen-titular', 'titular.html');
    renderObject(beneficiario, 'resumen-beneficiario', 'beneficiario.html');
    renderObject(inmueble, 'resumen-inmueble', 'inmueble.html');
    renderObject(compraventa, 'resumen-compraventa', 'compraventa.html');

    // Render Print View
    const fechaPrint = document.getElementById('print-fecha');
    if (fechaPrint) fechaPrint.textContent = new Date().toLocaleDateString();

    renderPrintObject(titular, 'print-titular');
    renderPrintObject(beneficiario, 'print-beneficiario');
    renderPrintObject(inmueble, 'print-inmueble');
    renderPrintObject(compraventa, 'print-compraventa');

    if (compraventa && compraventa.pagos) {
      const ul = document.getElementById('print-pagos');
      if (ul) {
        compraventa.pagos.forEach((p, i) => {
          const li = document.createElement('li');
          li.textContent = `Pago ${i + 1}: ${p.fecha} - Q${p.cantidad}`;
          ul.appendChild(li);
        });
      }
    }

    document.getElementById('btn-limpiar').addEventListener('click', () => {
      if (confirm("¬øEst√°s seguro de borrar todos los datos locales?")) {
        limpiarTodo();
        location.reload();
      }
    });

    document.getElementById('btn-finalizar').addEventListener('click', async () => {
      const payload = {
        titular, beneficiario, inmueble, compraventa
      };

      console.log("Enviando datos al backend:", payload);

      // Guardar en "DB Local" para simulaci√≥n de Estado de Cuenta (Backup)
      const nuevoId = guardarClienteDB(payload);

      // Validaci√≥n de protocolo (¬øEst√° en localhost?)
      if (window.location.protocol === 'file:') {
        alert("‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\nEst√°s abriendo el archivo directamente (file://).\nPara guardar en la BASE DE DATOS, debes abrirlo desde el servidor local (http://localhost/lospinos/...).\n\nLos datos se guardar√°n SOLO en el navegador por ahora.");
        limpiarTodo();
        window.location.href = "index.html";
        return; // Detener intento de fetch
      }

      try {
        const response = await fetch('procesar_formulario.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        // Leer texto crudo para depurar errores de PHP que no sean JSON
        const rawText = await response.text();
        let result;

        try {
          result = JSON.parse(rawText);
        } catch (e) {
          throw new Error("El servidor respondi√≥ con datos inv√°lidos (no JSON).\nPosible error de PHP:\n" + rawText.substring(0, 200));
        }

        if (result.success) {
          alert("‚úÖ ¬°√âxito! Expediente guardado en MySQL.\nID generado: " + result.id);
          limpiarTodo();
          window.location.href = "index.html";
        } else {
          alert("‚ùå Error del servidor MySQL: " + result.message);
        }
      } catch (error) {
        console.error(error);
        alert("‚ùå Error de Conexi√≥n:\n" + error.message + "\n\nSe ha guardado una copia LOCAL (Demo).");
        limpiarTodo();
        // window.location.href = "index.html"; // Opcional: recargar
      }
    });
  </script>
</body>

</html>