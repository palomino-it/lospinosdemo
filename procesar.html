<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Procesar Datos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>

  <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="img/RLP_LOGO.png" alt="RLP" class="logo-navbar">
        <img src="img/ML_LOGO.png" alt="ML" class="logo-navbar">
      </a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">üè† Men√∫ Principal</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container mt-5 pt-5">
    <div class="card shadow-lg p-4 rounded-4">
      <h2 class="text-center mb-4">Resumen Final del Expediente</h2>

      <div id="alert-container"></div>

      <div class="accordion" id="accordionResumen">

        <!-- Titular -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTitular">
              üë§ Datos del Titular
            </button>
          </h2>
          <div id="collapseTitular" class="accordion-collapse collapse show" data-bs-parent="#accordionResumen">
            <div class="accordion-body" id="resumen-titular">
              <p class="text-muted">No hay datos registrados.</p>
            </div>
          </div>
        </div>

        <!-- Beneficiario -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseBeneficiario">
              ü§ù Datos del Beneficiario
            </button>
          </h2>
          <div id="collapseBeneficiario" class="accordion-collapse collapse" data-bs-parent="#accordionResumen">
            <div class="accordion-body" id="resumen-beneficiario">
              <p class="text-muted">No hay datos registrados.</p>
            </div>
          </div>
        </div>

        <!-- Inmueble -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseInmueble">
              üè† Datos del Inmueble
            </button>
          </h2>
          <div id="collapseInmueble" class="accordion-collapse collapse" data-bs-parent="#accordionResumen">
            <div class="accordion-body" id="resumen-inmueble">
              <p class="text-muted">No hay datos registrados.</p>
            </div>
          </div>
        </div>

        <!-- Compraventa -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseCompraventa">
              üí∞ Datos de Compraventa
            </button>
          </h2>
          <div id="collapseCompraventa" class="accordion-collapse collapse" data-bs-parent="#accordionResumen">
            <div class="accordion-body" id="resumen-compraventa">
              <p class="text-muted">No hay datos registrados.</p>
            </div>
          </div>
        </div>

      </div>

      <div class="d-grid gap-2 mt-4 d-print-none">
        <button class="btn btn-primary btn-lg" onclick="window.print()">üñ®Ô∏è Imprimir Ficha del Cliente</button>
        <button class="btn btn-primary btn-lg" id="btn-finalizar">‚úÖ Finalizar y Guardar Expediente</button>
        <button class="btn btn-outline-danger" id="btn-limpiar">üóëÔ∏è Borrar Todo e Iniciar de Nuevo</button>
      </div>
    </div>
  </div>

  <!-- ================= Plantilla de Impresi√≥n ================= -->
  <div class="d-none d-print-block p-4" id="print-area">
    <div class="print-header mb-5">
      <div class="print-logos">
        <img src="img/RLP_LOGO.png" alt="RLP" class="print-logo">
        <div class="text-center flex-grow-1">
          <h3>RESIDENCIALES "LOS PINOS"</h3>
          <h4>Ficha de Control de Compraventa</h4>
        </div>
        <img src="img/ML_LOGO.png" alt="ML" class="print-logo">
      </div>
      <p class="text-end small">Fecha de Emisi√≥n: <span id="print-fecha"></span></p>
    </div>

    <div class="row mb-4">
      <div class="col-12 border p-3">
        <h4>1. DATOS DEL TITULAR</h4>
        <div id="print-titular" class="row"></div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12 border p-3">
        <h4>2. DATOS DEL BENEFICIARIO</h4>
        <div id="print-beneficiario" class="row"></div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12 border p-3">
        <h4>3. IDENTIFICACI√ìN DEL INMUEBLE</h4>
        <div id="print-inmueble" class="row"></div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-12 border p-3">
        <h4>4. CONDICIONES DE LA COMPRAVENTA</h4>
        <div id="print-compraventa" class="row"></div>
        <div class="mt-3">
          <strong>Pagos Programados:</strong>
          <ul id="print-pagos" class="list-unstyled ps-3"></ul>
        </div>
      </div>
    </div>

    <div class="row mt-5 pt-5 text-center">
      <div class="col-5 border-top border-dark">
        <p>Firma del Cliente</p>
      </div>
      <div class="col-2"></div>
      <div class="col-5 border-top border-dark">
        <p>Firma del Vendedor / Administraci√≥n</p>
      </div>
    </div>
  </div>

  <style>
    @media print {
      body * {
        visibility: hidden;
      }

      #print-area,
      #print-area * {
        visibility: visible;
      }

      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }

      .accordion,
      .navbar,
      .btn {
        display: none !important;
      }

      .card {
        box-shadow: none !important;
        border: none !important;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/app.js"></script>
  <script>
    function renderObject(obj, containerId) {
      if (!obj) return;
      let html = '<ul class="list-group">';
      for (const [key, value] of Object.entries(obj)) {
        if (key === 'pagos') {
          html += `<li class="list-group-item active">Pagos Fraccionados:</li>`;
          if (Array.isArray(value)) {
            value.forEach((p, i) => {
              html += `<li class="list-group-item ms-3">Pago ${i + 1}: ${p.fecha} - Q${p.cantidad}</li>`;
            });
          }
        } else {
          html += `<li class="list-group-item"><strong>${key}:</strong> ${value}</li>`;
        }
      }
      html += '</ul>';
      const container = document.getElementById(containerId);
      if (container) container.innerHTML = html;
    }

    function renderPrintObject(obj, containerId) {
      if (!obj) return;
      let html = '';
      for (const [key, value] of Object.entries(obj)) {
        if (key === 'pagos') continue;
        // Formato clave-valor simple para impresi√≥n, reordenando si es necesario
        html += `<div class="col-6 mb-1"><strong>${key}:</strong> ${value}</div>`;
      }
      const container = document.getElementById(containerId);
      if (container) container.innerHTML = html;
    }

    const titular = cargarDatos('titular');
    const beneficiario = cargarDatos('beneficiario');
    const inmueble = cargarDatos('inmueble');
    const compraventa = cargarDatos('compraventa');

    // Render Web View
    renderObject(titular, 'resumen-titular');
    renderObject(beneficiario, 'resumen-beneficiario');
    renderObject(inmueble, 'resumen-inmueble');
    renderObject(compraventa, 'resumen-compraventa');

    // Render Print View
    const fechaPrint = document.getElementById('print-fecha');
    if (fechaPrint) fechaPrint.textContent = new Date().toLocaleDateString();

    renderPrintObject(titular, 'print-titular');
    renderPrintObject(beneficiario, 'print-beneficiario');
    renderPrintObject(inmueble, 'print-inmueble');
    renderPrintObject(compraventa, 'print-compraventa');

    if (compraventa && compraventa.pagos) {
      const ul = document.getElementById('print-pagos');
      if (ul) {
        compraventa.pagos.forEach((p, i) => {
          const li = document.createElement('li');
          li.textContent = `Pago ${i + 1}: ${p.fecha} - Q${p.cantidad}`;
          ul.appendChild(li);
        });
      }
    }

    document.getElementById('btn-limpiar').addEventListener('click', () => {
      if (confirm("¬øEst√°s seguro de borrar todos los datos locales?")) {
        limpiarTodo();
        location.reload();
      }
    });

    document.getElementById('btn-finalizar').addEventListener('click', async () => {
      const payload = {
        titular, beneficiario, inmueble, compraventa
      };

      console.log("Enviando datos al backend:", payload);

      // Guardar en "DB Local" para simulaci√≥n de Estado de Cuenta
      const nuevoId = guardarClienteDB(payload);

      try {
        // Intentar enviar a PHP (esto fallar√° si no hay servidor, pero atrapamos el error para demo)
        const response = await fetch('procesar_formulario.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (result.success) {
          alert("¬°√âxito! Expediente guardado en Base de Datos. ID: " + nuevoId);
          limpiarTodo();
          window.location.href = "index.html";
        } else {
          alert("Error del servidor: " + result.message);
        }
      } catch (error) {
        console.warn("Fallo de red (esperado si no hay backend PHP corriendo):", error);
        // Fallback para demo
        const alertDiv = document.getElementById('alert-container');
        if (alertDiv) {
          alertDiv.innerHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                <strong>¬°Simulaci√≥n Exitosa!</strong><br>
                Cliente guardado localmente con ID: <strong>${nuevoId}</strong>.<br>
                Ahora puedes verlo en "Estado de Cuenta".
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
        }
        alert("DEMO: Cliente guardado localmente. ID: " + nuevoId);
        // Opcional: limpiarTodo() tras unos segundos o dejar que el usuario lo haga
      }
    });
  </script>
</body>

</html>